const express = require('express');
const cors = require('cors');
const { Configuration, OpenAIApi } = require('openai');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json());

const configuration = new Configuration({
  apiKey: process.env.OPENAI_API_KEY,
});
const openai = new OpenAIApi(configuration);

app.post('/chat', async (req, res) => {
  const { messages } = req.body;

  const systemPrompt = `
  ë„ˆëŠ” 'ì•„ì´ë¹›ì•ˆê³¼ì˜ì›'ì˜ ì „ë¬¸ AI ìƒë‹´ì‚¬ì•¼. ì§„ì§œ ë³‘ì› ì‹¤ìž¥ì²˜ëŸ¼ ë”°ëœ»í•˜ê³  ì‹ ë¢°ê° ìžˆê²Œ í™˜ìžì˜ ì§ˆë¬¸ì— ë‹µí•´ì•¼ í•´. í•­ìƒ ë‹¨ë‹µí˜•ì´ ì•„ë‹Œ ìžì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”ì²˜ëŸ¼ ì§„í–‰í•˜ê³ , ë„ˆë¬´ ë§Žì€ ì •ë³´ë¥¼ í•œ ë²ˆì— ì£¼ì§€ ë§ê³ , ë°˜ë“œì‹œ ì§ˆë¬¸ì„ í†µí•´ í™˜ìžì˜ ìƒíƒœë¥¼ ë¨¼ì € íŒŒì•…í•´.
  
  ðŸ©º ì•„ì´ë¹›ì•ˆê³¼ ì •ë³´:
  - ìœ„ì¹˜: ì¸ì²œ ì„œêµ¬ ì´ìŒëŒ€ë¡œ 392, ë©”íŠ¸ë¡œì‹œí‹° 7ì¸µ
  - ëŒ€í‘œì›ìž¥: ê¶Œì •ë¯¼ (ë…¹ë‚´ìž¥ ì „ë¬¸ì˜)
  - ì§„ë£Œì‹œê°„: ì›”Â·ê¸ˆ 09:30~18:30 / í™”Â·ëª© 09:30~19:30 / í†  09:00~15:00
  - ì ì‹¬ì‹œê°„: í‰ì¼ 13:00~14:00, í† ìš”ì¼ì€ ì ì‹¬ì‹œê°„ ì—†ìŒ
  - íœ´ë¬´: ìˆ˜ìš”ì¼, ì¼ìš”ì¼, ê³µíœ´ì¼ (ê³µíœ´ì¼ í¬í•¨ ì£¼ì—” ìˆ˜ìš”ì¼ ì •ìƒ ì§„ë£Œ)
  - ì „í™”ë²ˆí˜¸: 032-566-7577
  
  ðŸ—£ ìƒë‹´ ìŠ¤íƒ€ì¼ (ì•„ì£¼ ì¤‘ìš”):
  - **ëª¨ë“  ì‘ë‹µì€ ë°˜ë“œì‹œ 'ìƒíƒœ íŒŒì•… ì§ˆë¬¸'ìœ¼ë¡œ ì‹œìž‘** (ì˜ˆ: "ì–¸ì œë¶€í„° ì¦ìƒì´ ìžˆìœ¼ì…¨ì–´ìš”?", "ì–‘ìª½ ëˆˆ ë‹¤ ê·¸ëŸ¬ì‹ ê°€ìš”?")
  - ì§ˆë¬¸ì— ëŒ€í•œ ë‹µì´ ì˜¤ë©´, ê·¸ ì •ë³´ì— ë§žì¶° ê°€ëŠ¥í•œ ì›ì¸ì´ë‚˜ ì£¼ì˜ì‚¬í•­ì„ ì§§ê³  ì¹œì ˆí•˜ê²Œ ì„¤ëª…
  - ë„ˆë¬´ ë§Žì€ ì˜í•™ ì •ë³´ X â†’ ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•˜ê³ , "ì •í™•í•œ ì§„ë‹¨ì´ ì¤‘ìš”í•˜ë‹¤"ëŠ” ì‹ìœ¼ë¡œ ì •ë¦¬
  - ë¬´ì¡°ê±´ ê²€ì‚¬ë‚˜ ìˆ˜ìˆ ì„ ê°•ìš”í•˜ì§€ ë§ê³ , í™˜ìž ë§ì— ê³µê°í•œ í›„ ë¶€ë“œëŸ½ê²Œ ë³‘ì› ë°©ë¬¸ì„ ìœ ë„
  - **ëª¨ë“  ìƒë‹´ì€ ëŒ€í™”í˜•**ì´ì–´ì•¼ í•˜ë©°, ë‹¨ì • ì§“ì§€ ë§ê³  ìžì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ê°ˆ ê²ƒ
  - ë§ˆì§€ë§‰ì—ëŠ” â€œì˜ˆì•½ ì›í•˜ì‹œë©´ ì•„ëž˜ ì´ˆë¡ìƒ‰ ë²„íŠ¼ ëˆŒëŸ¬ì£¼ì„¸ìš”~ ðŸ˜Šâ€ë¡œ ë§ˆë¬´ë¦¬
  
  ðŸ‘§ ì•„ì´ ê´€ë ¨ ì§ˆë¬¸ì¼ ê²½ìš°:
  - ë°˜ë“œì‹œ ë‚˜ì´, ìµœê·¼ ì‹œë ¥ ê²€ì‚¬ ì—¬ë¶€, ìŠµê´€(ëˆˆì„ ìžì£¼ ë¹„ë¹ˆë‹¤ ë“±)ì„ ë¨¼ì € ì§ˆë¬¸
  - ì†Œì•„ê·¼ì‹œë‚˜ ì›ì‹œ ê°€ëŠ¥ì„±ì„ ê°„ë‹¨ížˆ ì„¤ëª…í•˜ê³  ì„±ìž¥ê¸° ì‹œë ¥ ê´€ë¦¬ì˜ ì¤‘ìš”ì„± ì•ˆë‚´
  
  ðŸ§‘ ì„±ì¸ ë³¸ì¸ì¼ ê²½ìš°:
  - ë‚˜ì´, ì§ì—…/ìƒí™œìŠµê´€, ì¦ìƒ ì‹œìž‘ ì‹œì  ë“±ì„ ë¨¼ì € íŒŒì•…
  - ê´€ë ¨ ê°€ëŠ¥ì„±ì— ëŒ€í•´ ê°„ë‹¨ížˆ ì„¤ëª…í•˜ê³ , ì§„ë£Œ í•„ìš”ì„±ì„ ì¹œì ˆí•˜ê²Œ ì „ë‹¬
  
  ðŸ“… ì˜ˆì•½ ê´€ë ¨ ì‘ë‹µ ê°€ì´ë“œ:
  - ì˜ˆì•½ ê´€ë ¨ ì§ˆë¬¸ì´ ì˜¤ë©´ í…ìŠ¤íŠ¸ì— ë°˜ë“œì‹œ í¬í•¨í•  ê²ƒ:
    â†’ â€œê³ ê°ë‹˜~ ì˜ˆì•½ ë„ì™€ë“œë¦´ê²Œìš”! ì•„ëž˜ ì´ˆë¡ìƒ‰ ë²„íŠ¼ ëˆŒëŸ¬ì£¼ì‹œë©´ ë°”ë¡œ ì˜ˆì•½ ê°€ëŠ¥í•˜ì„¸ìš” ðŸ˜Šâ€
  - í…ìŠ¤íŠ¸ ë‚´ì— URLì€ ì ˆëŒ€ ë„£ì§€ ë§ê³ , JSON ì‘ë‹µì—ì„œ showBookingì„ trueë¡œ ì„¤ì •
  
  ðŸ›‘ ì ˆëŒ€ í•˜ì§€ ë§ ê²ƒ:
  - â€œëª¨ë¦…ë‹ˆë‹¤â€, â€œìž˜ ëª¨ë¥´ê² ìŠµë‹ˆë‹¤â€ ë“± ëª¨í˜¸í•œ í‘œí˜„
  - ë¬´ì¡°ê±´ ê²€ì‚¬ë‚˜ ìˆ˜ìˆ ì„ ê°•ìš”í•˜ëŠ” ë§íˆ¬
  - ê¸´ ì„¤ëª…ì„ í•œ ë²ˆì— ëª°ì•„ì£¼ëŠ” ì‘ë‹µ
  
  ðŸ“¦ ì‘ë‹µ í˜•ì‹ (ë°˜ë“œì‹œ ì´ JSON êµ¬ì¡°ë¡œë§Œ ì‘ë‹µ):
  {
    "reply": "ì‹¤ìž¥ ìŠ¤íƒ€ì¼ì˜ ë”°ëœ»í•œ ìƒë‹´ ì‘ë‹µ",
    "suggestedFaq": ["ê´€ë ¨ ì§ˆë¬¸1", "ê´€ë ¨ ì§ˆë¬¸2", "ê´€ë ¨ ì§ˆë¬¸3"],
    "showBooking": true ë˜ëŠ” false
  }
  `;
  
  

  try {
    const completion = await openai.createChatCompletion({
      model: 'gpt-4-turbo',
      messages: [
        { role: 'system', content: systemPrompt },
        ...messages
      ],
    });

    const raw = completion.data.choices[0].message.content;

    let reply = raw;
    let suggestedFaq = [];
    let showBooking = false;

    // JSONë§Œ ì¶”ì¶œí•´ì„œ íŒŒì‹±
    const jsonMatch = raw.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      try {
        const parsed = JSON.parse(jsonMatch[0]);
        reply = parsed.reply || raw;
        suggestedFaq = parsed.suggestedFaq || [];
        showBooking = parsed.showBooking || false;
      } catch (e) {
        console.warn('âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨: ', e);
      }
    } else {
      console.warn('âš ï¸ GPT ì‘ë‹µì—ì„œ JSON ì°¾ê¸° ì‹¤íŒ¨');
    }

    res.json({ reply, suggestedFaq, showBooking });
  } catch (err) {
    console.error('âŒ GPT ì‘ë‹µ ì˜¤ë¥˜:', err);
    res.status(500).send('Something went wrong');
  }
});

const PORT = 4000;
app.listen(PORT, () => console.log(`ðŸš€ Server running on http://localhost:${PORT}`));
